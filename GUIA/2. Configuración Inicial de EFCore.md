# Configuración Inicial de Entity Framework Core

Este documento detalla los pasos esenciales para configurar y utilizar **Entity Framework Core (EF Core)** en un proyecto .NET, EF Core es un **ORM (Object-Relational Mapper)** que facilita la manipulación de datos mediante objetos C#, eliminando la necesidad de escribir consultas SQL directamente.

## 1. Instalación de Paquetes NuGet

Para integrar EF Core en tu proyecto, es necesario instalar los paquetes NuGet correspondientes. La instalación debe realizarse estratégicamente en las capas adecuadas de tu solución evitando
hacerlo en la solución completa.

### Ubicación de la Instalación

- **Capa `Infrastructure`**: Aquí se instalarán los paquetes principales de EF Core, ya que esta capa es la responsable de la implementación del acceso a datos.
- **Capa `API` (o proyecto de inicio)**: Solo se instalará `Microsoft.EntityFrameworkCore.Tools`. Este paquete proporciona las herramientas de línea de comandos para gestionar migraciones, las cuales se aplicarán a la base de datos a través de la configuración definida en la capa `Infrastructure`.

### Paquetes Esenciales

Se pueden instalar mediante la **Consola del Administrador de Paquetes** en Visual Studio o a través de la **CLI de .NET**.

#### Para la capa `Infrastructure`:

- **Paquete principal de EF Core:**
  `bash
dotnet add package Microsoft.EntityFrameworkCore
    `

- **Proveedor de base de datos (ej. SQL Server):**
  `bash
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
    `
  _(Si utilizas otra base de datos como PostgreSQL o MySQL, deberás instalar el paquete correspondiente, por ejemplo, `Microsoft.EntityFrameworkCore.PostgreSQL` o `MySql.EntityFrameworkCore`.)_

#### Para la capa `API` (o proyecto de inicio):

- **Herramientas de migración:**
  `bash
dotnet add package Microsoft.EntityFrameworkCore.Tools
    `

Alternativamente, puedes usar la interfaz gráfica de \*\*

Manage NuGet Packages\*\* haciendo clic derecho sobre cada capa en el Explorador de Soluciones.

## 2. Crear el `DbContext`

El `DbContext` es la clase central en EF Core que actúa como una sesión con la base de datos. Permite consultar, insertar, actualizar y eliminar datos. Debes crear una clase que herede de `DbContext` y definir propiedades `DbSet<T>` para cada entidad de tu modelo de dominio.

**Ejemplo de `ApplicationDbContext`:**

```csharp
namespace StarWarsCRUD.Infrastructure.Data;

public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options) { }

    // Define tus entidades como propiedades DbSet<T>
    public DbSet<Personaje> Personajes { get; set; }
    // public DbSet<OtraEntidad> OtrasEntidades { get; set; }
}
```

## 3. Configurar la Cadena de Conexión

EF Core necesita una cadena de conexión para saber cómo conectarse a tu base de datos. Esta configuración se realiza típicamente en el archivo `appsettings.json` de tu proyecto de API o de inicio.

**Ejemplo en `appsettings.json`:**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=BibliotecaDB;Trusted_Connection=True;"
  }
}
```

**Nota de Seguridad:** Para entornos de desarrollo, es común usar `appsettings.Development.json` para almacenar cadenas de conexión y otras configuraciones sensibles, evitando que se incluyan accidentalmente en entornos de producción.

## 4. Registrar el `DbContext` en el Contenedor de Dependencias

Para que tu `DbContext` esté disponible a través de la inyección de dependencias en tu aplicación, debes registrarlo en el contenedor de servicios. Esto se hace en el archivo `Program.cs` de tu proyecto de API o de inicio.

**En `Program.cs` (sección de servicios):**

```csharp
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
```

Este código registra `ApplicationDbContext` como un servicio con un ciclo de vida `Scoped`, lo que significa que se creará una nueva instancia del contexto para cada solicitud HTTP, ideal para operaciones de base de datos.

## 5. Crear y Aplicar Migraciones

Las migraciones de EF Core permiten gestionar los cambios en el esquema de tu base de datos de forma controlada, basándose en los cambios que realices en tus clases de entidad C#.

### Pasos para Crear y Aplicar Migraciones

1.  **Asegúrate de que el proyecto de `Infrastructure` (donde reside tu `DbContext`) sea el proyecto de inicio en la consola de comandos.**
2.  **Crea una nueva migración:**
    `bash
dotnet ef migrations add InitialCreate
    `
    _(Reemplaza `InitialCreate` con un nombre descriptivo para tu migración, por ejemplo, `AddUsersTable`.)_

3.  **Aplica la migración a la base de datos:**
    `bash
dotnet ef database update
    `

**Alternativa (Consola del Administrador de Paquetes en Visual Studio):**

```powershell
Add-Migration InitialCreate
Update-Database
```

## Resumen Teórico

- **EF Core** actúa como un traductor, mapeando tus clases C# a tablas de base de datos y viceversa.
- El **`DbContext`** es el puente fundamental que conecta tu código con la base de datos, gestionando las operaciones de datos.
- Las **Migraciones** son una herramienta poderosa para evolucionar el esquema de tu base de datos de manera controlada y versionada, reflejando los cambios en tu modelo de dominio.
